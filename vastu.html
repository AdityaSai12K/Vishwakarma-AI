<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vastu AI â€” VISHWAKARMA AI</title>
  <link href="css/styles.css" rel="stylesheet" />
  <style>
    /* minimal inline helpers so the page looks OK if your css file isn't present */
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#fafafa; color:#111; margin:0; padding:0 1rem 4rem; }
    .container{max-width:1100px;margin:4rem auto}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:1.25rem;margin-bottom:1.25rem;box-shadow:0 6px 20px rgba(16,24,40,0.04)}
    .btn{background:#6b46c1;color:#fff;border:none;padding:0.6rem 1rem;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input[type="file"]{display:none}
    .hidden{display:none}
    .flex{display:flex;gap:.75rem;align-items:center}
    .col{display:flex;flex-direction:column;gap:.5rem}
    pre{white-space:pre-wrap}
    .toast{position:fixed;right:1rem;top:1rem;background:#111;color:#fff;padding:.6rem .9rem;border-radius:8px;z-index:2000}
    .preview-img{max-width:100%;height:auto;border-radius:8px;border:1px solid #eee}
    .muted{color:#666;font-size:.95rem}
    .room, .issue, .suggestion { padding:.6rem;border-radius:8px;margin-bottom:.5rem;border:1px solid #eee;background:#fff }
    .score-circle{width:120px;height:120px;border-radius:999px;border:10px solid #eee;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.4rem}
    #chat-output{height:220px;overflow:auto;padding:.6rem;border-radius:8px;border:1px solid #eee;background:#fafafa}
    .msg-user{align-self:flex-end;background:#6b46c1;color:#fff;padding:.5rem .75rem;border-radius:10px;max-width:80%}
    .msg-bot{align-self:flex-start;background:#fff;padding:.5rem .75rem;border-radius:10px;border:1px solid #eee;max-width:80%}
  </style>
</head>
<body>
  <div class="container">
    <h1>Vastu AI â€” VISHWAKARMA AI</h1>
    <p class="muted">Upload a 2D floor plan (JPG/PNG/PDF). The app will attempt AI analysis; if the AI call fails, a mock report is shown so the UI always responds.</p>

    <div class="card" id="upload-card">
      <div class="col">
        <div class="flex">
          <label for="blueprint-input" class="btn" id="open-file-btn">Select Blueprint</label>
          <button class="btn" id="analyze-now-btn">Start Vastu Analysis</button>
          <div id="status" class="muted" style="margin-left:auto">Ready</div>
        </div>

        <input id="blueprint-input" type="file" accept="image/jpeg,image/jpg,image/png,application/pdf">

        <div id="preview-area" class="col" style="margin-top:1rem">
          <div id="preview-notice" class="muted">No file selected</div>
          <img id="preview-img" class="preview-img hidden" alt="preview">
        </div>
      </div>
    </div>

    <div class="card hidden" id="processing-card">
      <div class="muted">Processing â€” analyzing blueprint. This UI will show mock results if the AI call can't run.</div>
    </div>

    <div class="card hidden" id="results-card">
      <div style="display:flex;gap:1rem;align-items:center">
        <div class="score-circle" id="score-value">0</div>
        <div>
          <div style="font-weight:700" id="score-assessment">-</div>
          <div class="muted" id="score-summary">-</div>
        </div>
      </div>

      <hr style="margin:1rem 0">

      <h3>Detected Rooms</h3>
      <div id="rooms-container"></div>

      <h3>Positives</h3>
      <div id="positives-container"></div>

      <h3>Issues</h3>
      <div id="issues-container"></div>

      <h3>Suggestions</h3>
      <div id="suggestions-container"></div>
    </div>

    <!-- Chatbot -->
    <div class="card">
      <h3>Ask Vastu Bot</h3>
      <div id="chat-output" class="col">
        <div class="muted">Ask anything about Vastu or the analysis</div>
      </div>

      <div style="display:flex;gap:.5rem;margin-top:.75rem">
        <input id="chat-input" placeholder="Type a question..." style="flex:1;padding:.6rem;border-radius:8px;border:1px solid #eee">
        <button id="chat-send" class="btn">Ask</button>
      </div>
    </div>

    <div id="log" class="muted" style="margin-top:1rem"></div>
  </div>

  <!-- Minimal toast helper -->
  <div id="toast" class="toast hidden"></div>

  <script>
  /************************************************************************
   * VASTU HTML â€” SINGLE FILE IMPLEMENTATION
   *
   * - Includes your API key (INSECURE client-side) because you asked for it.
   * - Production: Move this key to server-side!
   *
   * Your provided Google API key (you put it in chat):
   *   AIzaSyBHV5d_9scp-Tpg6Zh4j0pEnHtMDHQgv6Y
   *
   ************************************************************************/

  (function () {
    'use strict';

    // ---------- CONFIG ----------
    const CLIENT_SIDE_API_KEY = "AIzaSyBHV5d_9scp-Tpg6Zh4j0pEnHtMDHQgv6Y"; // !!! Insecure in browser, rotate later
    const GEMINI_MODEL_TO_TRY = "gemini-1.5"; // we try a generic name; model availability depends on SDK & account
    const USE_AI_TIMEOUT_MS = 20000; // give API up to 20s

    // ---------- DOM ----------
    const fileInput = document.getElementById('blueprint-input');
    const openFileBtn = document.getElementById('open-file-btn');
    const analyzeNowBtn = document.getElementById('analyze-now-btn');
    const statusEl = document.getElementById('status');
    const previewImg = document.getElementById('preview-img');
    const previewNotice = document.getElementById('preview-notice');
    const processingCard = document.getElementById('processing-card');
    const resultsCard = document.getElementById('results-card');

    const scoreValueEl = document.getElementById('score-value');
    const scoreAssessmentEl = document.getElementById('score-assessment');
    const scoreSummaryEl = document.getElementById('score-summary');

    const roomsContainer = document.getElementById('rooms-container');
    const positivesContainer = document.getElementById('positives-container');
    const issuesContainer = document.getElementById('issues-container');
    const suggestionsContainer = document.getElementById('suggestions-container');

    const chatOutput = document.getElementById('chat-output');
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send');

    const toast = document.getElementById('toast');
    const logEl = document.getElementById('log');

    // ---------- Utilities ----------
    function showToast(text, ms = 3000) {
      toast.textContent = text;
      toast.classList.remove('hidden');
      setTimeout(()=> toast.classList.add('hidden'), ms);
    }
    function log(msg) { console.log(msg); if (logEl) logEl.textContent = msg; }

    function resetUIToUpload() {
      processingCard.classList.add('hidden');
      resultsCard.classList.add('hidden');
      document.getElementById('upload-card').classList.remove('hidden');
      statusEl.textContent = 'Ready';
    }

    function showProcessing() {
      document.getElementById('upload-card').classList.add('hidden');
      processingCard.classList.remove('hidden');
      resultsCard.classList.add('hidden');
      statusEl.textContent = 'Processing...';
    }

    function showResults() {
      processingCard.classList.add('hidden');
      resultsCard.classList.remove('hidden');
      statusEl.textContent = 'Complete';
    }

    // Show preview for images, and a placeholder message for PDFs
    function previewFile(file) {
      if (!file) {
        previewImg.classList.add('hidden');
        previewNotice.textContent = 'No file selected';
        return;
      }
      if (file.type === 'application/pdf') {
        previewImg.classList.add('hidden');
        previewNotice.textContent = `PDF selected: ${file.name}. (Preview not supported in this demo.)`;
        return;
      }
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      previewImg.onload = () => { URL.revokeObjectURL(url); };
      previewImg.classList.remove('hidden');
      previewNotice.textContent = `${file.name} (${Math.round(file.size/1024)} KB)`;
    }

    // Basic function to attempt to call Gemini client SDK if available
    // If it fails, we return null and caller should fallback to mock
    async function attemptGeminiAnalyze(promptText, fileBase64, mimeType) {
      // Check SDK availability - window.GoogleGenerativeAI or window.genAI etc.
      const sdk = window.GoogleGenerativeAI || window.genAI || window['@google/generative-ai'];
      if (!sdk && !window.google || (!window.GoogleGenerativeAI && !window.genAI)) {
        log('Gemini SDK not available in window; skipping AI call');
        return null;
      }

      try {
        // There are multiple unofficial bundles â€” try common constructors:
        let client;
        if (typeof window.GoogleGenerativeAI === 'function') {
          client = new window.GoogleGenerativeAI(CLIENT_SIDE_API_KEY);
        } else if (window.genAI && typeof window.genAI === 'object' && typeof window.genAI.getGenerativeModel === 'function') {
          // some UMD wrappers set window.genAI to an already-initialized client
          client = window.genAI;
        } else if (window['@google/generative-ai'] && typeof window['@google/generative-ai'].GoogleGenerativeAI === 'function') {
          client = new window['@google/generative-ai'].GoogleGenerativeAI(CLIENT_SIDE_API_KEY);
        } else {
          log('Unknown SDK shape â€” cannot initialize client safely');
          return null;
        }

        log('Initialized Gemini client (best-effort). Attempting model call...');

        // Try to get a model (best-effort)
        let model;
        try {
          model = client.getGenerativeModel ? client.getGenerativeModel({ model: GEMINI_MODEL_TO_TRY }) : client;
        } catch (merr) {
          // If getGenerativeModel fails, try using client directly
          log('getGenerativeModel failed â€” will attempt client-level generateContent if available', merr);
          model = client;
        }

        // Build request parts similar to examples: text prompt + inlineData
        const parts = [
          { text: promptText },
          { inlineData: { data: fileBase64, mimeType: mimeType } }
        ];

        // If generateContent is a function on model, call it
        if (!model.generateContent && client.generateContent) {
          model = client;
        }
        if (typeof model.generateContent !== 'function') {
          log('generateContent not found on model/client');
          return null;
        }

        // Promise race with timeout
        const callPromise = model.generateContent(parts);
        const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error('AI timeout')), USE_AI_TIMEOUT_MS));
        const result = await Promise.race([callPromise, timeout]);

        // result.response.text() or result.output[0].content[0].text?.text depending on SDK â€” try common shapes
        let text = '';
        if (!result) throw new Error('No result from model');
        try {
          if (typeof result.response?.text === 'function') {
            text = result.response.text();
          } else if (result.output && result.output.length && result.output[0].content) {
            // try digging
            const content = result.output[0].content.find(c => c.type === 'text' || c.type === 'output_text') || result.output[0].content[0];
            text = content?.text || content?.text?.trim() || JSON.stringify(result.output);
          } else if (typeof result === 'string') {
            text = result;
          } else {
            text = JSON.stringify(result).slice(0, 2000);
          }
        } catch (e) {
          log('Could not extract text from result: ' + e.message);
          text = JSON.stringify(result).slice(0, 2000);
        }

        log('AI responded; length=' + (text?.length || 0));
        return text;
      } catch (err) {
        console.error('Gemini call failed:', err);
        return null;
      }
    }

    // Helper: convert file to base64 string (no data: prefix)
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          if (!reader.result) return reject(new Error('Empty read result'));
          const s = reader.result.toString();
          const comma = s.indexOf(',');
          resolve(comma >= 0 ? s.slice(comma + 1) : s);
        };
        reader.onerror = () => reject(new Error('File read error'));
        reader.onabort = () => reject(new Error('File read aborted'));
        reader.readAsDataURL(file);
      });
    }

    // Try to parse JSON embedded in text; otherwise return null
    function tryExtractJSON(text) {
      if (!text) return null;
      // remove markdown fences
      text = text.trim();
      text = text.replace(/^```json\s*/i, '').replace(/\s*```$/i, '');
      text = text.replace(/^```\s*/i, '').replace(/\s*```$/i, '');
      // locate first { ... } block
      const match = text.match(/\{[\s\S]*\}$/);
      if (match) {
        try {
          return JSON.parse(match[0]);
        } catch (e) {
          // continue to try plain parse
        }
      }
      try {
        return JSON.parse(text);
      } catch (e) {
        return null;
      }
    }

    // Mock analyzer (guaranteed to return data)
    function getMockReportVariant(fileName = '') {
      // simple cycle based on timestamp or filename hash for variety
      const t = Date.now();
      const variant = t % 3;
      if (variant === 0) {
        return {
          score: 88,
          assessment: 'GOOD',
          summary: 'Good Vastu alignment; a few minor tweaks recommended.',
          rooms: [{name:'Kitchen',direction:'SE',status:'good'},{name:'Master Bedroom',direction:'SW',status:'good'},{name:'Toilet',direction:'NE',status:'bad'}],
          positives: ['Kitchen in SE','Master bedroom in SW'],
          issues: [{message:'Toilet in NE',severity:'high'}],
          suggestions: ['Move toilet away from NE','Place small water bowl in NE to balance']
        };
      } else if (variant === 1) {
        return {
          score: 70,
          assessment: 'FAIR',
          summary: 'Average compliance; a few important corrections needed.',
          rooms: [{name:'Kitchen',direction:'E',status:'ok'},{name:'Bedroom',direction:'NW',status:'ok'},{name:'Bathroom',direction:'NE',status:'bad'}],
          positives: ['Main entrance good'],
          issues: [{message:'Bathroom in NE',severity:'high'},{message:'Center clutter',severity:'medium'}],
          suggestions: ['Relocate bathroom, declutter center area','Add plants in east']
        };
      } else {
        return {
          score: 94,
          assessment: 'EXCELLENT',
          summary: 'Excellent layout â€” maintain current placements.',
          rooms: [{name:'Kitchen',direction:'SE',status:'excellent'},{name:'Pooja Room',direction:'NE',status:'excellent'}],
          positives: ['All wet areas away from NE','Pooja in NE'],
          issues: [],
          suggestions: ['Keep centre uncluttered','Maintain ventilation']
        };
      }
    }

    // Update UI with data object
    function updateResultsUI(data) {
      if (!data) return;
      scoreValueEl.textContent = Math.round(data.score || 0);
      scoreAssessmentEl.textContent = (data.assessment || 'UNKNOWN').toUpperCase();
      scoreSummaryEl.textContent = data.summary || '';

      // Rooms
      if (Array.isArray(data.rooms) && data.rooms.length) {
        roomsContainer.innerHTML = data.rooms.map(r => `<div class="room"><strong>${r.name}</strong> â€” ${r.direction || 'Unknown'} ${r.status ? '('+r.status+')':''}</div>`).join('');
      } else {
        roomsContainer.innerHTML = '<div class="room muted">No rooms detected.</div>';
      }

      // Positives
      if (Array.isArray(data.positives) && data.positives.length) {
        positivesContainer.innerHTML = data.positives.map(p => `<div class="room">âœ” ${p}</div>`).join('');
      } else {
        positivesContainer.innerHTML = '<div class="room muted">No positives reported.</div>';
      }

      // Issues
      if (Array.isArray(data.issues) && data.issues.length) {
        issuesContainer.innerHTML = data.issues.map(i => `<div class="issue">âš  ${i.severity ? '<b>['+i.severity.toUpperCase()+']</b> ' : ''}${i.message || i}</div>`).join('');
      } else {
        issuesContainer.innerHTML = '<div class="issue muted">No issues detected.</div>';
      }

      // Suggestions
      if (Array.isArray(data.suggestions) && data.suggestions.length) {
        suggestionsContainer.innerHTML = data.suggestions.map(s => `<div class="suggestion">ðŸ’¡ ${s}</div>`).join('');
      } else {
        suggestionsContainer.innerHTML = '<div class="suggestion muted">No suggestions.</div>';
      }
    }

    // ---------- Main analyze flow ----------
    async function analyzeFile(file) {
      try {
        showProcessing();
        showToast('Converting file...');
        const base64 = await fileToBase64(file);
        log('base64 length: ' + base64.length);

        // Compose a strong prompt requesting strict JSON
        const prompt = `
You are a Vastu Shastra expert. Analyze the attached floor plan image/PDF.
Assume top of image = North, bottom = South, left = West, right = East.
Detect rooms, determine coarse directions (N, NE, E, SE, S, SW, W, NW), list positives, issues (with severity), suggestions, and give an overall score 0-100.

Return ONLY valid JSON (no markdown, no explanation) in this format:
{
  "score": 75,
  "assessment": "good",
  "summary": "Short summary",
  "rooms": [{"name":"Kitchen","direction":"SE","status":"good"}],
  "positives": ["Kitchen in SE"],
  "issues": [{"message":"Toilet in NE","severity":"high"}],
  "suggestions": ["Move toilet to SW"]
}
        `.trim();

        showToast('Attempting AI analysis (may fail if SDK/model unavailable)...', 4000);
        const aiText = await attemptGeminiAnalyze(prompt, base64, file.type).catch(e => { console.error(e); return null; });

        let data = null;
        if (aiText) {
          // Try to parse JSON from response
          data = tryExtractJSON(aiText);
          if (!data) {
            console.warn('AI returned text but JSON extraction failed. AI text preview:', aiText.slice(0,1000));
          } else {
            console.log('Parsed JSON from AI');
          }
        }

        // If AI didn't work or returned non-JSON, fallback to mock
        if (!data) {
          console.warn('Falling back to mock report');
          data = getMockReportVariant(file.name);
        }

        // Update UI with data
        updateResultsUI(data);
        showResults();
        showToast('Analysis ready');
      } catch (err) {
        console.error('analyzeFile error', err);
        showToast('Analysis failed â€” using mock result');
        const data = getMockReportVariant();
        updateResultsUI(data);
        showResults();
      }
    }

    // ---------- Chatbot ----------
    async function sendChatMessage(userText) {
      if (!userText) return;
      appendChatMessage(userText, true);
      chatInput.value = '';
      chatSendBtn.disabled = true;
      showToast('Thinking...');
      // Try Gemini first (via same client routine)
      const prompt = `System: You are Vastu Bot. Provide short, friendly, 1-2 sentence answers about Vastu. User: ${userText}\nAnswer:`;
      let aiText = null;
      try {
        aiText = await attemptGeminiAnalyze(prompt, null, null);
      } catch (e) { aiText = null; }

      if (!aiText) {
        // fallback simple rules
        aiText = fallbackChatbotAnswer(userText);
      }

      appendChatMessage(aiText, false);
      chatSendBtn.disabled = false;
    }

    function appendChatMessage(text, isUser) {
      // Remove placeholder muted note when first message happens
      if (chatOutput.querySelector('.muted')) chatOutput.innerHTML = '';
      const div = document.createElement('div');
      div.className = isUser ? 'msg-user' : 'msg-bot';
      div.textContent = text;
      chatOutput.appendChild(div);
      chatOutput.scrollTop = chatOutput.scrollHeight;
    }

    function fallbackChatbotAnswer(userText) {
      // very lightweight heuristics to give plausible quick reply
      const t = userText.toLowerCase();
      if (t.includes('toilet') || t.includes('bath')) return 'Toilets are generally not recommended in NE; consider moving wet areas to SW/W.';
      if (t.includes('kitchen')) return 'Kitchen should ideally be in SE (Agni) or E; avoid NW for kitchen appliances.';
      if (t.includes('door') || t.includes('entrance')) return 'Main entrance facing NE, N or E is considered auspicious; ensure it is clutter-free.';
      if (t.includes('score') || t.includes('rating')) return 'I can give a quick 0â€“100 compliance score after seeing the plan â€” upload it to get an analysis.';
      return 'For precise fixes, upload the plan and run the analysis. Generally, NE = worship/study, SW = master bedroom, SE = kitchen.';
    }

    // ---------- Wire UI events ----------
    openFileBtn.addEventListener('click', ()=> fileInput.click());

    fileInput.addEventListener('change', (ev) => {
      const f = ev.target.files?.[0];
      if (!f) return;
      previewFile(f);
    });

    analyzeNowBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      const f = fileInput.files?.[0];
      if (!f) {
        showToast('Please select a file first');
        return;
      }
      analyzeNowBtn.disabled = true;
      analyzeFile(f).finally(()=> analyzeNowBtn.disabled = false);
    });

    // Chatbot
    chatSendBtn.addEventListener('click', ()=> {
      const v = chatInput.value.trim();
      if (!v) return;
      sendChatMessage(v);
    });
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        chatSendBtn.click();
      }
    });

    // Initial state
    resetUIToUpload();
    log('Vastu UI ready (client-only demo).');

    // Optional: attempt to load Google SDK automatically if you include script tags externally.
    // (We don't inject remote scripts here for security; include them in your HTML head if desired)
  })();
  </script>
</body>
</html>